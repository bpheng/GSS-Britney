---
title: 'EDA HNSC'
author: "Sehyun Oh, Britney Pheng"
date: "`r format(Sys.time(), '%B %d, %Y')`"
format:
    html:
        fontsize: 14pxs
        toc: true
        top-depth: 3
output: html_document
---

# Set up
## Load Packages
```{r warning=FALSE, message=FALSE}
suppressPackageStartupMessages({
  library(GenomicSuperSignature)
  library(curatedTCGAData)
  library(MultiAssayExperiment)
  library(TCGAutils)
  library(tidyr)
  library(dplyr)
  library(ggplot2)
  library(magick)
  library(wordcloud)
  library(EnrichmentBrowser)
  library(ztable)
  library(magrittr)
})
```

## Load TCGA dataset
```{r}
load("~/Documents/GitHub/GSS/data/TCGA_validationDatasets.rda")
datasets <- TCGA_validationDatasets[1:7]
```

## Load RAVmodel
```{r warning=FALSE, message=FALSE}
RAVmodel <- getModel("C2", load=TRUE)
```

## Select HNSC RNA metadata
```{r message=FALSE, warning=FALSE}
hnsc <- curatedTCGAData(diseaseCode = "HNSC", 
                        assays = "RNA*", 
                        version = "2.0.1", 
                        dry.run = FALSE)

hnsc_rna <- getWithColData(hnsc, 
                           "HNSC_RNASeq2Gene-20160128", 
                           mode = "append")

hnsc_meta <- colData(hnsc_rna)
```

# heatmapTable: HNSC
```{r message=FALSE}
val_hnsc <- validate(datasets$HNSC, RAVmodel)
heatmapTable(val_hnsc, RAVmodel)
```

# Subset
## Filter attributes
```{r}
sparsity_summary <- table(colSums(is.na(hnsc_meta)))
sparsity_summary
```
## Sparsity Plot
```{r echo=FALSE}
plot(stack(sparsity_summary)$ind, 
     stack(sparsity_summary)$values)
```

```{r}
# Only select for columns with more than 10% completeness
keep_attr_ind <- which(colSums(!is.na(hnsc_meta)) > round(nrow(hnsc_meta)/10))
meta_sub1 <- hnsc_meta[keep_attr_ind]
meta_sub1 <- subset(meta_sub1, select = -patientID)
```

```{r}
# Randomly select for 100 rows
set.seed(1)
random_sample_ind <- sample(1:nrow(meta_sub1), 100)
meta_sub2 <- meta_sub1[random_sample_ind,]
```


```{r}
# Check for data types in listData
unique(sapply(hnsc_meta@listData, type))

charcTb <- meta_sub2[, sapply(meta_sub2, class) == 'character']
numTb <- meta_sub2[, sapply(meta_sub2, class) %in% c('numeric', 'integer')]
```

```{r}
# Calculate validation scores
sampleScore <- calculateScore(hnsc_rna, RAVmodel)
```

```{r warning = FALSE, message = FALSE}
# Select for RAVs with a minimum silhouette width of 0.4
val_all <- validate(hnsc_rna, RAVmodel)
validated_ind <- validatedSignatures(val_all, num.out = 30, RAVmodel,
                                     swCutoff = 0.4, indexOnly = TRUE)
validated_ind
```

```{r}
# Subset sampleScore to join with MCPcounter
sampleScore_sub <- sampleScore[random_sample_ind, validated_ind] %>% as.data.frame() 
```

# Calculate r-squared value
## Numeric variables
```{r calculateRsq}
# R squared value function
calculateRsq <- function (x, y) stats::cor(x, y, use = "na.or.complete") ^ 2
```

```{r warning=FALSE}
# Calculate r-squared for numeric attributes
rsq_numAttr_tb <- as.data.frame(matrix(nrow = ncol(numTb), 
                                       ncol = ncol(sampleScore_sub)))

colnames(rsq_numAttr_tb) <- colnames(sampleScore_sub)
rownames(rsq_numAttr_tb) <- colnames(numTb)

for (i in seq_len(ncol(numTb))) {
    for (j in seq_len(ncol(sampleScore_sub))) {
        rsq <- calculateRsq(numTb[,i], sampleScore_sub[,j])
        rsq_numAttr_tb[i, j] <- rsq
    }
}
```

```{r}
dim(rsq_numAttr_tb) # 330 features x 21 RAVs
# rsq_numAttr_tb[1:10, 1:20]
max_rav <- apply(rsq_numAttr_tb, 1, max)
max_attr <- which(max_rav > 0.4 & max_rav < 1) # Decreased the lower limit to 0.4
max_rav[max_attr]
```
## Features with an r squared value > 0.4
```{r}
target_rsq <- rsq_numAttr_tb[max_attr,]
```

# heatmapTable
```{r results='asis'}
options(ztable.type="html")
z = ztable(target_rsq)
z %>% makeHeatmap()
```
# Calculate F-Statistic (ANOVA)
## Character variables
```{r}
# Convert to factor data type
factorTb <- meta_sub2[, sapply(meta_sub2, class) == 'character']
factorTb[sapply(factorTb, is.character)] <- lapply(factorTb[sapply(factorTb, is.character)], factor, exclude = NULL)

new_ind <- c()

# Select for factors with at least two possible values
for (i in 1:length(factorTb)) {
  if (nlevels(factorTb[, i]) > 1) {
    new_ind <- c(new_ind, i)
  }
}

new_factorTb <- factorTb[,new_ind]
```

```{r}
# Calculate p-value for factor attributes
aov_res <- as.data.frame(matrix(nrow = ncol(new_factorTb),
                                ncol = ncol(sampleScore_sub)))

rownames(aov_res) <- colnames(new_factorTb)
colnames(aov_res) <- colnames(sampleScore_sub)

aov_fvalue <- aov_res
aov_pvalue <- aov_res

for (i in seq_len(ncol(sampleScore_sub))) {
  for (j in seq_len(ncol(new_factorTb))) {
      
      ## ANOVA
      aov <- aov(sampleScore_sub[, i] ~ new_factorTb[, j])
      
      ## F value
      fval <- summary(aov)[[1]]$`F value`[1]
      aov_fvalue[j, i] <- fval
      
      ## P value
      pval <- summary(aov)[[1]]$`Pr(>F)`[1]
      aov_pvalue[j, i] <- pval
  }
}
```

```{r mcc, echo=FALSE}
aov_fvalue <- aov_res
aov_pvalue <- aov_res

for (i in seq_len(ncol(sampleScore_sub))) {
  for (j in seq_len(ncol(new_factorTb))) {
      
      ## ANOVA
      mcc_res <- mcc(sampleScore_sub[, i] ~ new_factorTb[, j])
      
      ## F value
      fval <- summary(aov)[[1]]$`F value`[1]
      aov_fvalue[j, i] <- fval
      
      ## P value
      pval <- summary(aov)[[1]]$`Pr(>F)`[1]
      aov_pvalue[j, i] <- pval
  }
}
```


```{r echo=FALSE, eval=FALSE}
## Save for plotting optimization
write.csv(aov_fvalue, "aov_fvalue.csv", row.names = TRUE)
write.csv(aov_pvalue, "aov_pvalue.csv", row.names = TRUE)
```

```{r}
# Select for p-values < 0.05
min_rav <- apply(aov_factorAttr_tb, 1, min)
min_attr <- which(min_rav < 0.05)
head(min_rav[min_attr])
```
## Features with a p-value < 0.05
```{r}
target_aov <- aov_factorAttr_tb[min_attr,]
```

# heatmapTable
```{r results='asis', message=FALSE}
options(ztable.type="html")
ztable(target_aov) %>%
  makeHeatmap(palette = 'Blues') %>%
  print(caption="ANOVA p-values")
```
## RAV Exploration
```{r}
ind <- 1125
findStudiesInCluster(RAVmodel, ind, studyTitle = TRUE)
subsetEnrichedPathways(RAVmodel, ind, include_nes = TRUE) %>% as.data.frame
drawWordcloud(RAVmodel, ind)
```
```{r}
ind <- 4486
findStudiesInCluster(RAVmodel, ind, studyTitle = TRUE)
subsetEnrichedPathways(RAVmodel, ind, include_nes = TRUE) %>% as.data.frame
drawWordcloud(RAVmodel, ind)
```
